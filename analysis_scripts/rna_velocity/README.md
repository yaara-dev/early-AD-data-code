# RNA Velocity Analysis Pipeline  
**Direct Execution with Example Input**

This repository provides an implementation of the RNA velocity and spatial interaction analyses used in the manuscript.  
The pipeline is designed to be executed **directly via the main analysis script** without any auxiliary runner scripts.

---

## Main analysis script

### `src/rna_velocity_all_tissues.py`

This script implements the complete RNA velocity and spatial analysis pipeline, including:

1. Per-cell normalization of spliced (cytoplasmic) RNA counts
2. K-nearest-neighbor (KNN) pooling in expression/PCA space
3. Gene-wise estimation of the splicing parameter γ from spliced–unspliced phase portraits
4. RNA velocity computation per gene and per cell
5. Prediction of future cell states at time *T* and projection into a fixed PCA space
6. Distance-stratified analysis of **magnitude** of cell-state change (proximal vs distal; 5xFAD vs WT)
7. Distance-stratified analysis of **phase** of cell-state change (permutation testing)
8. Continuous association between physical distance and magnitude of cell-state change
9. Gene-level association between RNA velocity and physical proximity
10. Region-stratified repetition of Sections 6–7 and 9 within anatomical regions

The script is fully parameterized via command-line arguments and can be applied to both example and real datasets without modification.

---

## Input data

All required inputs are provided under:

```
data/example_input/
```

The example input is synthetic and intended solely for reproducibility and code inspection.

### Input files

#### `pc_origin_counts_0_example_input.csv`
Cell-level metadata table.

- Rows: cells (`cell_id`)
- Columns:
  - `cell_type` – annotated cell type
  - `group` – experimental condition (`5X` or `WT`)
  - `region` – anatomical region label
  - `PC1`, `PC2`, `PC3` – PCA coordinates of the initial transcriptional state
  - `x_um`, `y_um` – physical centroid coordinates (µm)
  - `radius_um` – estimated cell radius (µm)

#### `spliced_final.csv`
Spliced (cytoplasmic) RNA count matrix (cells × genes).  
The first column is a dummy column retained for pipeline compatibility.

#### `unspliced_final.csv`
Unspliced (nuclear) RNA count matrix (cells × genes).  
Same format as `spliced_final.csv`.

#### `neighbors.csv`
Nearest-neighbor ordering in PCA space used for KNN pooling.  
If not provided, it is computed automatically from `PC1–PC3`.

---

## Running the analysis

The pipeline can be executed **directly** using the main script:

```bash
python src/rna_velocity_all_tissues.py   --meta_csv data/example_input/pc_origin_counts_0_example_input.csv   --spliced_csv data/example_input/spliced_final.csv   --unspliced_csv data/example_input/unspliced_final.csv   --neighbors_csv data/example_input/neighbors.csv   --out_dir RESULTS
```

No additional scripts are required.

---

## RESULTS directory

All outputs generated by the pipeline are written to:

```
RESULTS/
```

### Core outputs

#### `gammas_table.csv`
Gene-wise estimates of the splicing parameter γ and low-expression filtering flags.

#### `per_cell_delta_pc.csv`
Per-cell displacement vectors in PCA space.

#### `per_cell_mag_angle.csv`
Magnitude and phase (angle) of cell-state change per cell.

#### `per_cell_min_boundary_um.csv`
Minimum physical boundary distances used for proximity stratification.

---

### Distance-based statistics (global)

#### `per_pair_mwu_magnitude_by_proximality.csv`
Distance-stratified comparison of magnitude between 5xFAD and WT (Mann–Whitney U test, BH-FDR).

#### `per_pair_phase_permutation_by_proximality.csv`
Distance-stratified comparison of phase between 5xFAD and WT (permutation test, BH-FDR).

#### `per_pair_distance_magnitude_correlation.csv`
Continuous association between physical distance and magnitude of cell-state change.

#### `gene_velocity_distance_correlation.csv`
Gene-level correlations between RNA velocity and physical distance.

---

### Region-stratified outputs

All analyses above are repeated independently within each anatomical region.

- `per_region_pair_mwu_magnitude_by_proximality.csv`
- `per_region_pair_phase_permutation_by_proximality.csv`
- `per_region_gene_velocity_distance_correlation.csv`

---

## Notes

- The example input dataset is synthetic and provided for reproducibility only.
- All files under `RESULTS/` are generated outputs and can be reproduced by re-running the pipeline.
